name: ğŸ“¦ Rust CI

on: [push, pull_request]

jobs:
  build:
    name: ğŸ§ Build & Test on Linux
    runs-on: ubuntu-latest
    
    # ğŸ”¥ å¢åŠ èµ„æº
    env:
      RUST_BACKTRACE: 1
      CARGO_INCREMENTAL: 0  # åœ¨ CI ä¸­ç¦ç”¨å¢é‡ç¼–è¯‘
      RUSTFLAGS: "-D warnings"  # å°†è­¦å‘Šè½¬ä¸ºé”™è¯¯

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      # ğŸ”¥ ä¼˜åŒ–ç¼“å­˜
      - name: ğŸ“¦ Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: "true"
          cache-target-dir: "true"
          cache-key: "v1-${{ hashFiles('**/Cargo.lock') }}"

      - name: ğŸš© Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          libxdo-dev \
          protobuf-compiler \
          libglib2.0-dev \
          libgdk-pixbuf-2.0-dev \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          pkg-config

      # ğŸ”¥ åªæ„å»ºå¿…è¦çš„ target
      - name: â›ï¸ Build
        run: |
          cargo build --locked --release
          # å¦‚æœæœ‰å¤šä¸ª profileï¼Œå¯ä»¥å¹¶è¡Œæ„å»º
          # cargo build --locked --profile ci  # å¦‚æœå®šä¹‰äº† ci profile

      - name: ğŸ§ª Run tests
        run: cargo test --locked --release -- --nocapture

      # ğŸ”¥ å¯é€‰ï¼šæ„å»ºè¦†ç›–ç‡æŠ¥å‘Š
      - name: ğŸ“Š Code coverage
        if: github.ref == 'refs/heads/main'
        run: |
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml

