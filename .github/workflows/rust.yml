name: ğŸ“¦ Rust CI

on: [push, pull_request]

jobs:
  build:
    name: ğŸ§ Build & Test on Linux
    runs-on: ubuntu-latest
    
    # ğŸ”¥ å¢åŠ èµ„æº
    env:
      RUST_BACKTRACE: 1
      CARGO_INCREMENTAL: 0  

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      # ğŸ”¥ ä¼˜åŒ–ç¼“å­˜
      - name: ğŸ“¦ Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: "true"
          cache-target-dir: "true"
          cache-key: "v1-${{ hashFiles('**/Cargo.lock') }}"

      - name: ğŸš© Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          libxdo-dev \
          protobuf-compiler \
          libglib2.0-dev \
          libgdk-pixbuf-2.0-dev \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          pkg-config

      # ğŸ”¥ åªæ„å»ºå¿…è¦çš„ target
      - name: â›ï¸ Build
        run: |
          cargo build --locked --release
          # å¦‚æœæœ‰å¤šä¸ª profileï¼Œå¯ä»¥å¹¶è¡Œæ„å»º
          # cargo build --locked --profile ci  # å¦‚æœå®šä¹‰äº† ci profile

      - name: ğŸ§ª Run tests
        run: cargo test --locked --release -- --nocapture

      # ğŸ”¥ æ”¹è¿›è¦†ç›–ç‡æŠ¥å‘Š
      - name: ğŸ“Š Code coverage
        if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
        run: |
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml --out Html --output-dir ./coverage

      # ğŸ”¥ ä¸Šä¼ å¤šç§æ ¼å¼çš„æŠ¥å‘Š
      - name: ğŸ“¤ Upload coverage reports
        if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            ./coverage/
            cobertura.xml
            tarpaulin-report.html
          retention-days: 30

